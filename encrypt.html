<script>
  function generateRandomKey(length = 16) {
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }

  function generate() {
    const phone = document.getElementById('phone').value.trim();
    const paramCode = "fizz";
    const paramKey = "bazz";

    if (!phone.match(/^\d{10,15}$/)) {
      alert("Bitte eine gÃ¼ltige Telefonnummer im internationalen Format angeben.");
      return;
    }

    const key = generateRandomKey();
    const encrypted = CryptoJS.AES.encrypt(phone, key).toString();

    // Automatische Basis-URL
    const baseurl = `${window.location.origin}${window.location.pathname.replace("encrypt.html", "index.html")}`;

    const url = `${baseurl}?${paramCode}=${encodeURIComponent(encrypted)}&${paramKey}=${encodeURIComponent(key)}`;
    document.getElementById('finalurl').value = url;

    // Nur QR-Code generieren, wenn die URL valide ist
    if (url.length > 0) {
      QRCode.toCanvas(document.getElementById("qrcode"), url, function (error) {
        if (error) {
          console.error("QR-Code Fehler:", error);
          alert("Fehler beim Erzeugen des QR-Codes.");
        }
      });
    }
  }
</script>
